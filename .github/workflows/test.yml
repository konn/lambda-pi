on: push
name: Build and Test

env:
  CABAL: cabal --project-file=cabal-ci.project

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    outputs:
      store-cache-key: ${{ steps.calc-cache-keys.outputs.store-cache-key}}
      dist-cache-key: ${{ steps.calc-cache-keys.outputs.dist-cache-key}}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Calc cache-keys
      id: calc-cache-keys
      run: |
        HS_FILE_HASH=${{hashFiles('**/*.hs')}}
        echo "HS_FILE_HASH=${HS_FILE_HASH}" >> "${GITHUB_ENV}"
        FREEZE_FILE_HASH=${{hashFiles('cabal.project.freeze')}}
        echo "FREEZE_FILE_HASH=${FREEZE_FILE_HASH}" >> "${GITHUB_ENV}"
        PACKAGE_FILE_HASH=${{ hashFiles('package.yaml', '**/*.cabal') }}
        echo "PACKAGE_FILE_HASH=${PACKAGE_FILE_HASH}" >> "${GITHUB_ENV}"

        STORE_CACHE_KEY="ubuntu-9.2.8-cabal-store-${FREEZE_FILE_HASH}-${PACKAGE_FILE_HASH}-${{github.sha}}"
        echo "store-cache-key=${STORE_CACHE_KEY}" >> "${GITHUB_OUTPUT}"
        
        DIST_CACHE_KEY="ubuntu-9.2.8-dist-newstyle-${FREEZE_FILE_HASH}-${PACKAGE_FILE_HASH}-${HS_FILE_HASH}-${{github.sha}}"
        echo "dist-cache-key=${DIST_CACHE_KEY}" >> "${GITHUB_OUTPUT}"

    - name: Restore ~/.cabal/store
      uses: actions/cache/restore@v3
      with:
        path: ~/.cabal/store
        key: |
          ${{steps.calc-cache-keys.outputs.store-cache-key}}
        restore-keys: |
          ubuntu-9.2.8-cabal-store-${{env.FREEZE_FILE_HASH}}-${{env.PACKAGE_FILE_HASH}}-
          ubuntu-9.2.8-cabal-store-${{env.FREEZE_FILE_HASH}}-
          ubuntu-9.2.8-cabal-store-

    - name: Restore ./dist-newstyle
      uses: actions/cache/restore@v3
      with:
        path: dist-newstyle
        key: |
          ${{steps.calc-cache-keys.outputs.dist-cache-key}}
        restore-keys: |
          ubuntu-9.2.8-dist-newstyle-${FREEZE_FILE_HASH}-${PACKAGE_FILE_HASH}-${HS_FILE_HASH}-
          ubuntu-9.2.8-dist-newstyle-${FREEZE_FILE_HASH}-${PACKAGE_FILE_HASH}-
          ubuntu-9.2.8-dist-newstyle-${FREEZE_FILE_HASH}-
          ubuntu-9.2.8-dist-newstyle-
    - name: Setup Haskell
      uses: haskell/actions/setup@v2
      with:
        cabal-version: 3.10.1.0
        ghc-version: 9.2.8
    - run: ${CABAL} update
    - name: Build dependencies
      run: |
        ${CABAL} build --only-dependencies all

    - name: Save ~/.cabal/store
      uses: actions/cache/save@v3
      with:
        path: ~/.cabal/store
        key:  ${{steps.calc-cache-keys.outputs.store-cache-key}}

    - name: Build All
      id: build
      run: ${CABAL} build all

    - name: Save ./dist-newstyle
      if: ${{ steps.build.conclusion == 'success' }}
      uses: actions/cache/save@v3
      with:
        path: dist-newstyle
        key: ${{steps.calc-cache-keys.outputs.dist-cache-key}}

  test:
    name: Run Tests
    runs-on: ubuntu-22.04
    needs: build
    steps:
    - uses: actions/checkout@v3
    - name: Setup Haskell
      uses: haskell/actions/setup@v2
      with:
        cabal-version: 3.10.1.0
        ghc-version: 9.2.8
    - name: Restore ~/.cabal/store
      uses: actions/cache/restore@v3
      with:
        path: ~/.cabal/store
        key: ${{ needs.build.outputs.store-cache-key }}
        fail-on-cache-miss: true
    - name: Restore Test Cache
      uses: actions/cache/restore@v3
      with:
        key: ${{ needs.build.outputs.dist-cache-key }}
        path: dist-newstyle
        fail-on-cache-miss: true
    - name: Run Tests
      run: ${{env.CABAL}} test all
